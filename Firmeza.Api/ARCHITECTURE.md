# Arquitectura de la API Firmeza

## ๐ Diagrama de Arquitectura en Capas

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                         CLIENTES                                 โ
โ  (Blazor, React, Angular, Mobile Apps, Postman, curl)          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ HTTP/HTTPS
                         โ JSON
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    FIRMEZA.API (ASP.NET Core)                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ              MIDDLEWARE PIPELINE                          โ  โ
โ  โ  โข CORS                                                   โ  โ
โ  โ  โข Authentication (JWT)                                   โ  โ
โ  โ  โข Authorization                                          โ  โ
โ  โ  โข Exception Handling                                     โ  โ
โ  โ  โข Swagger UI                                             โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                                                                  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                   CONTROLLERS                             โ  โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โ    Auth      โ  โ   Products   โ  โ   Clients    โ   โ  โ
โ  โ  โ  Controller  โ  โ  Controller  โ  โ  Controller  โ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ   โ  โ
โ  โ  โโโโโโโโโโโโโโโโ                                        โ  โ
โ  โ  โ    Sales     โ                                        โ  โ
โ  โ  โ  Controller  โ                                        โ  โ
โ  โ  โโโโโโโโโโโโโโโโ                                        โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                           โ                                     โ
โ                           โ DTOs                                โ
โ                           โผ                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                   AUTOMAPPER                              โ  โ
โ  โ  Entity โโ DTO Mapping                                   โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                           โ                                     โ
โ                           โผ                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                    SERVICES                               โ  โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ                      โ  โ
โ  โ  โ    Auth      โ  โ    Email     โ                      โ  โ
โ  โ  โ   Service    โ  โ   Service    โ                      โ  โ
โ  โ  โ    (JWT)     โ  โ   (SMTP)     โ                      โ  โ
โ  โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ                      โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ              FIRMEZA.INFRASTRUCTURE                              โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ           GENERIC REPOSITORY                              โ  โ
โ  โ  โข GetAllAsync()                                          โ  โ
โ  โ  โข GetByIdAsync()                                         โ  โ
โ  โ  โข AddAsync()                                             โ  โ
โ  โ  โข UpdateAsync()                                          โ  โ
โ  โ  โข DeleteAsync()                                          โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ                           โ                                     โ
โ                           โผ                                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ         APPLICATION DB CONTEXT                            โ  โ
โ  โ  (Entity Framework Core)                                  โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    FIRMEZA.CORE                                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                   ENTITIES                                โ  โ
โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ               โ  โ
โ  โ  โ Product  โ  โ  Client  โ  โ   Sale   โ               โ  โ
โ  โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ               โ  โ
โ  โ  โโโโโโโโโโโโ                                            โ  โ
โ  โ  โSaleDetailโ                                            โ  โ
โ  โ  โโโโโโโโโโโโ                                            โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ                  INTERFACES                               โ  โ
โ  โ  โข IGenericRepository<T>                                  โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                         โ
                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    POSTGRESQL DATABASE                           โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ       โ
โ  โ Products โ  โ Clients  โ  โ  Sales   โ  โAspNetUsersโ       โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ  โโโโโโโโโโโโ       โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ                                    โ
โ  โSaleDetailsโ โAspNetRolesโ                                   โ
โ  โโโโโโโโโโโโ  โโโโโโโโโโโโ                                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ Flujo de una Request

### Ejemplo: GET /api/products

```
1. Cliente โ HTTP GET /api/products
                โ
2. Middleware Pipeline
   - CORS: โ Permitir origen
   - Auth: โ Token vรกlido (opcional)
                โ
3. ProductsController.GetAll()
   - Recibe request
   - Valida parรกmetros
                โ
4. Repository.GetAllAsync()
   - Consulta base de datos
   - Retorna List<Product>
                โ
5. AutoMapper
   - Product โ ProductDto
                โ
6. Controller
   - Retorna OkResult(ProductDto[])
                โ
7. JSON Serialization
   - ProductDto[] โ JSON
                โ
8. Cliente โ HTTP 200 OK + JSON
```

### Ejemplo: POST /api/sales (con autenticaciรณn)

```
1. Cliente โ HTTP POST /api/sales + JWT Token
                โ
2. Middleware Pipeline
   - CORS: โ Permitir origen
   - Auth: โ Validar JWT
   - Authorization: โ Usuario autenticado
                โ
3. SalesController.Create(CreateSaleDto)
   - Valida DTO
   - Verifica cliente existe
                โ
4. Business Logic
   - Para cada producto:
     โข Verificar stock
     โข Reducir stock
     โข Crear SaleDetail
   - Calcular total
                โ
5. Repository.AddAsync(Sale)
   - Guardar en base de datos
                โ
6. EmailService.SendPurchaseConfirmation()
   - Enviar email asรญncrono
                โ
7. AutoMapper
   - Sale โ SaleDto
                โ
8. Controller
   - Retorna CreatedAtAction(SaleDto)
                โ
9. Cliente โ HTTP 201 Created + JSON
```

## ๐ Flujo de Autenticaciรณn JWT

```
โโโโโโโโโโโโ                                    โโโโโโโโโโโโ
โ  Client  โ                                    โ   API    โ
โโโโโโฌโโโโโโ                                    โโโโโโฌโโโโโโ
     โ                                                โ
     โ  1. POST /api/auth/login                      โ
     โ    { email, password }                        โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโบโ
     โ                                                โ
     โ                                    2. Validar credenciales
     โ                                       (UserManager)
     โ                                                โ
     โ                                    3. Generar JWT Token
     โ                                       - Claims: email, roles
     โ                                       - Expira: 24h
     โ                                                โ
     โ  4. 200 OK                                     โ
     โ    { token, email, roles, expiration }        โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                                                โ
     โ  5. Guardar token                              โ
     โ                                                โ
     โ  6. GET /api/products                          โ
     โ     Authorization: Bearer <token>             โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโบโ
     โ                                                โ
     โ                                    7. Validar token
     โ                                       - Firma vรกlida?
     โ                                       - No expirado?
     โ                                                โ
     โ  8. 200 OK + Productos                         โ
     โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
     โ                                                โ
```

## ๐ Diagrama de Base de Datos

```sql
โโโโโโโโโโโโโโโโโโโโโโโ
โ   AspNetUsers       โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ Id (PK)             โ
โ Email               โ
โ PasswordHash        โ
โโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Many-to-Many
         โ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   AspNetRoles       โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ Id (PK)             โ
โ Name                โ
โ โข Administrator     โ
โ โข Client            โ
โโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโ       โโโโโโโโโโโโโโโโโโโโโโโ
โ      Clients        โ       โ      Products       โ
โโโโโโโโโโโโโโโโโโโโโโโค       โโโโโโโโโโโโโโโโโโโโโโโค
โ Id (PK)             โ       โ Id (PK)             โ
โ Name                โ       โ Name                โ
โ Document            โ       โ Description         โ
โ Email               โ       โ Price               โ
โ Phone               โ       โ Stock               โ
โ Address             โ       โโโโโโโโโโโโโโโโโโโโโโโ
โโโโโโโโโโโโโโโโโโโโโโโ                โ
         โ                              โ
         โ 1:N                          โ 1:N
         โ                              โ
         โผ                              โ
โโโโโโโโโโโโโโโโโโโโโโโ                โ
โ       Sales         โ                โ
โโโโโโโโโโโโโโโโโโโโโโโค                โ
โ Id (PK)             โ                โ
โ ClientId (FK)       โ                โ
โ Date                โ                โ
โ Total               โ                โ
โโโโโโโโโโโโโโโโโโโโโโโ                โ
         โ                              โ
         โ 1:N                          โ
         โ                              โ
         โผ                              โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ           SaleDetails                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโค
โ Id (PK)                                 โ
โ SaleId (FK)                             โ
โ ProductId (FK)                          โ
โ Quantity                                โ
โ UnitPrice                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ฏ Patrones de Diseรฑo Utilizados

### 1. Repository Pattern
- Abstracciรณn del acceso a datos
- `IGenericRepository<T>`
- Facilita testing con mocks

### 2. Dependency Injection
- Inyecciรณn de dependencias en constructores
- Configurado en `Program.cs`
- Ciclo de vida: Scoped

### 3. DTO Pattern
- Separaciรณn entre entidades y DTOs
- Evita over-posting
- Control de datos expuestos

### 4. Service Layer
- Lรณgica de negocio en servicios
- `AuthService`, `EmailService`
- Reutilizable y testeable

### 5. Middleware Pipeline
- Procesamiento de requests en cadena
- CORS โ Auth โ Authorization โ Controllers

## ๐ Seguridad

### Autenticaciรณn
- JWT Bearer Tokens
- Tokens firmados con HMAC-SHA256
- Expiraciรณn de 24 horas

### Autorizaciรณn
- Basada en roles
- `[Authorize(Roles = "Administrator")]`
- Claims en el token

### Validaciรณn
- Model validation automรกtica
- DTOs con data annotations
- Validaciรณn de negocio en servicios

### CORS
- Configurado para permitir cualquier origen (desarrollo)
- Debe restringirse en producciรณn

## ๐ Escalabilidad

### Horizontal
- Stateless (JWT)
- Sin sesiones en servidor
- Puede escalar con load balancer

### Vertical
- Async/await en todos los mรฉtodos
- Connection pooling de EF Core
- Preparado para cachรฉ (Redis)

### Base de Datos
- รndices en claves forรกneas
- Paginaciรณn preparada
- Queries optimizadas con Include

## ๐งช Testing

```
โโโโโโโโโโโโโโโโโโโโโโโ
โ   Firmeza.Test      โ
โโโโโโโโโโโโโโโโโโโโโโโค
โ โข xUnit             โ
โ โข Moq               โ
โ โข Unit Tests        โ
โโโโโโโโโโโโโโโโโโโโโโโ
         โ
         โ Tests
         โผ
โโโโโโโโโโโโโโโโโโโโโโโ
โ   Controllers       โ
โ โข ProductsControllerโ
โ โข ClientsController โ
โ โข SalesController   โ
โ โข AuthController    โ
โโโโโโโโโโโโโโโโโโโโโโโ
```

## ๐ณ Deployment

```
Docker Compose
โโโ db (PostgreSQL)
โ   โโโ Port: 5432
โโโ web (Firmeza.Admin)
โ   โโโ Port: 5000
โโโ api (Firmeza.Api)
    โโโ Port: 5001
    
Network: firmeza-network
```
